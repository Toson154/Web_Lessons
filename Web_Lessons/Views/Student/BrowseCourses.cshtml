    @model IEnumerable<Web_Lessons.Models.Course>
    @{
        Layout = "_StudentLayout";
        ViewData["Title"] = "Browse Courses";
        ViewData["Description"] = "Discover and enroll in new courses";

        var subjects = ViewBag.Subjects as List<Web_Lessons.Models.Subject>;
        var levels = ViewBag.Levels as List<string>;
        var search = ViewBag.Search as string;
        var selectedLevel = ViewBag.Level as string;
        var selectedSubjectId = ViewBag.SubjectId as int?;
        var enrolledCourseIds = ViewBag.EnrolledCourseIds as List<int> ?? new List<int>();
        var totalPublished = ViewBag.TotalPublished as int? ?? 0;
    }

    <div class="row">
        <!-- Filters Sidebar -->
        <div class="col-md-3 mb-4">
            <div class="content-card">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">Filters</h5>
                    <span class="badge bg-primary">@totalPublished courses</span>
                </div>

                <form method="get" asp-action="BrowseCourses" id="filterForm">
                    <!-- Search -->
                    <div class="mb-3">
                        <label class="form-label">Search Courses</label>
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="fas fa-search"></i>
                            </span>
                            <input type="text"
                                   name="search"
                                   class="form-control"
                                   value="@search"
                                   placeholder="Search by title, description..."
                                   id="searchInput" />
                        </div>
                    </div>

                    <!-- Level Filter -->
                    <div class="mb-3">
                        <label class="form-label">Level</label>
                        <select name="level" class="form-select" id="levelSelect">
                            <option value="">All Levels</option>
                            @if (levels != null)
                            {
                                foreach (var level in levels)
                                {
                                    <option value="@level" selected="@(level == selectedLevel)">@level</option>
                                }
                            }
                        </select>
                    </div>

                    <!-- Subject Filter -->
                    <div class="mb-3">
                        <label class="form-label">Subject</label>
                        <select name="subjectId" class="form-select" id="subjectSelect">
                            <option value="">All Subjects</option>
                            @if (subjects != null && subjects.Any())
                            {
                                foreach (var subject in subjects)
                                {
                                    <option value="@subject.Id" selected="@(subject.Id == selectedSubjectId)">
                                        @subject.Name
                                    </option>
                                }
                            }
                        </select>
                    </div>

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary" id="applyFilters">
                            <i class="fas fa-filter me-2"></i>Apply Filters
                        </button>
                        <a asp-action="BrowseCourses" class="btn btn-outline-secondary">
                            <i class="fas fa-times me-2"></i>Clear All
                        </a>
                    </div>
                </form>
            </div>

            <!-- Quick Stats -->
            <div class="content-card mt-3">
                <h6 class="mb-3">Quick Stats</h6>
                <div class="mb-2">
                    <small class="text-muted">Total Courses</small>
                    <div class="fw-bold">@totalPublished</div>
                </div>
                <div class="mb-2">
                    <small class="text-muted">Your Enrollments</small>
                    <div class="fw-bold">@enrolledCourseIds.Count</div>
                </div>
                <div>
                    <small class="text-muted">Subjects</small>
                    <div class="fw-bold">@(subjects?.Count ?? 0)</div>
                </div>
            </div>
        </div>

        <!-- Courses List -->
        <div class="col-md-9">
            <!-- Header -->
            <div class="content-card mb-4">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h4 class="mb-1">Available Courses</h4>
                        <p class="text-muted mb-0">
                            @if (!string.IsNullOrEmpty(search) || !string.IsNullOrEmpty(selectedLevel) || selectedSubjectId.HasValue)
                            {
                                <span>Filtered results (@Model.Count())</span>
                            }
                            else
                            {
                                <span>All published courses (@totalPublished)</span>
                            }
                        </p>
                    </div>
                    <div>
                        <a asp-controller="Student" asp-action="MyCourses" class="btn btn-outline-primary">
                            <i class="fas fa-bookmark me-2"></i>My Courses (@enrolledCourseIds.Count)
                        </a>
                    </div>
                </div>
            </div>

            <!-- Courses Grid -->
            @if (!Model.Any())
            {
                <div class="content-card text-center py-5">
                    <div class="empty-state">
                        <i class="fas fa-search fa-4x text-muted mb-4"></i>
                        <h4>No courses found</h4>
                        <p class="text-muted mb-4">
                            @if (!string.IsNullOrEmpty(search) || !string.IsNullOrEmpty(selectedLevel) || selectedSubjectId.HasValue)
                            {
                                <span>No courses match your search criteria.</span>
                            }
                            else
                            {
                                <span>No published courses available at the moment.</span>
                            }
                        </p>
                        <a asp-action="BrowseCourses" class="btn btn-primary">
                            <i class="fas fa-sync-alt me-2"></i>Clear Filters
                        </a>
                    </div>
                </div>
            }
            else
            {
                <div class="row">
                    @foreach (var course in Model)
                    {
                        var isEnrolled = enrolledCourseIds.Contains(course.Id);
                        var lessonCount = course.Lessons?.Count ?? 0;
                        var studentCount = course.Enrollments?.Count ?? 0;

                        <div class="col-lg-4 col-md-6 mb-4">
                            <div class="card course-card h-100 @(isEnrolled ? "border-success" : "")">
                                @if (!string.IsNullOrEmpty(course.ThumbnailUrl))
                                {
                                    <div class="course-image" style="background-image: url('@course.ThumbnailUrl');">
                                        @if (isEnrolled)
                                        {
                                            <div class="enrolled-badge">
                                                <i class="fas fa-check-circle"></i> Enrolled
                                            </div>
                                        }
                                    </div>
                                }
                                else
                                {
                                    <div class="course-image" style="background: linear-gradient(135deg, #4361ee 0%, #7209b7 100%);">
                                        @if (isEnrolled)
                                        {
                                            <div class="enrolled-badge">
                                                <i class="fas fa-check-circle"></i> Enrolled
                                            </div>
                                        }
                                        <div class="d-flex align-items-center justify-content-center h-100">
                                            <i class="fas fa-graduation-cap fa-3x text-white opacity-50"></i>
                                        </div>
                                    </div>
                                }
                                <div class="card-body d-flex flex-column">
                                    <div class="mb-2">
                                        <span class="badge bg-info">@course.Level</span>
                                        @if (course.Subject != null)
                                        {
                                            <span class="badge bg-secondary ms-1">@course.Subject.Name</span>
                                        }
                                    </div>

                                    <h5 class="card-title mb-3">@course.Title</h5>

                                    @if (!string.IsNullOrEmpty(course.Description))
                                    {
                                        <p class="card-text text-muted small flex-grow-1">
                                            @(course.Description.Length > 120 ?
                                                course.Description.Substring(0, 120) + "..." :
                                                course.Description)
                                        </p>
                                    }

                                    <div class="course-stats mt-3">
                                        <div class="d-flex justify-content-between text-muted small">
                                            <span>
                                                <i class="fas fa-video me-1"></i>@lessonCount lessons
                                            </span>
                                            <span>
                                                <i class="fas fa-users me-1"></i>@studentCount students
                                            </span>
                                        </div>
                                    </div>

                                    <div class="mt-3">
                                        @if (isEnrolled)
                                        {
                                            <a asp-controller="Student"
                                   asp-action="CourseDetails"
                                   asp-route-id="@course.Id"
                                               class="btn btn-success w-100">
                                                <i class="fas fa-play-circle me-2"></i>Continue Learning
                                            </a>
                                        }
                                        else
                                        {
                                            <form asp-controller="Student"
                                      asp-action="Enroll"
                                                  method="post"
                                                  class="w-100 enroll-form"
                                                  data-course-id="@course.Id">
                                                @Html.AntiForgeryToken()
                                                <input type="hidden" name="courseId" value="@course.Id" />
                                                <button type="submit"
                                                        class="btn btn-primary w-100 enroll-btn"
                                                        data-course-id="@course.Id"
                                                        data-course-title="@course.Title">
                                                    <i class="fas fa-plus-circle me-2"></i>Enroll Now
                                                </button>
                                            </form>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
        </div>
    </div>

    @section Styles {
        <style>
            .course-card {
                border: none;
                border-radius: 12px;
                overflow: hidden;
                box-shadow: 0 4px 12px rgba(0,0,0,0.08);
                transition: all 0.3s ease;
                border: 2px solid transparent;
            }

                .course-card:hover {
                    transform: translateY(-5px);
                    box-shadow: 0 10px 25px rgba(0,0,0,0.15);
                    border-color: #3498db;
                }

                .course-card.border-success {
                    border-color: #28a745 !important;
                }

            .course-image {
                height: 160px;
                width: 100%;
                background-size: cover;
                background-position: center;
                position: relative;
            }

            .enrolled-badge {
                position: absolute;
                top: 10px;
                right: 10px;
                background: rgba(40, 167, 69, 0.9);
                color: white;
                padding: 5px 10px;
                border-radius: 20px;
                font-size: 12px;
                font-weight: 500;
            }

            .empty-state {
                padding: 40px 0;
            }

                .empty-state i {
                    opacity: 0.5;
                }

            .card-body {
                padding: 1.5rem;
            }

            .course-stats {
                border-top: 1px solid #eee;
                padding-top: 1rem;
            }

            .content-card {
                background: white;
                border-radius: 12px;
                padding: 1.5rem;
                box-shadow: 0 4px 12px rgba(0,0,0,0.05);
                margin-bottom: 1.5rem;
            }

            /* Loading animation for enroll button */
            .enroll-btn.loading {
                position: relative;
                color: transparent !important;
            }

                .enroll-btn.loading:after {
                    content: "";
                    position: absolute;
                    width: 20px;
                    height: 20px;
                    top: 50%;
                    left: 50%;
                    margin: -10px 0 0 -10px;
                    border: 2px solid rgba(255,255,255,0.3);
                    border-radius: 50%;
                    border-top-color: #fff;
                    animation: spin 1s ease-in-out infinite;
                }

            @@keyframes spin {
                to {
                    transform: rotate(360deg);
                }
            }
        </style>
    }

    @section Scripts {
        <script>
            $(document).ready(function () {
                console.log("BrowseCourses page loaded");

                // Auto-submit form when filter changes
                $('#levelSelect, #subjectSelect').on('change', function () {
                    $('#filterForm').submit();
                });

                // Debounce search input
                let searchTimeout;
                $('#searchInput').on('input', function () {
                    clearTimeout(searchTimeout);
                    const searchTerm = $(this).val();

                    searchTimeout = setTimeout(function () {
                        if (searchTerm.length === 0 || searchTerm.length >= 2) {
                            $('#filterForm').submit();
                        }
                    }, 500);
                });

                // Enroll button click handler - Improved with AJAX
                $('.enroll-form').on('submit', function (e) {
                    e.preventDefault();

                    const form = $(this);
                    const btn = form.find('.enroll-btn');
                    const courseTitle = btn.data('course-title');
                    const courseId = btn.data('course-id');

                    // Show loading state
                    btn.addClass('loading');
                    btn.prop('disabled', true);
                    btn.html('<span class="spinner-border spinner-border-sm me-2"></span>Enrolling...');

                    // Show toast notification
                    showToast(`Enrolling in "${courseTitle}"...`, 'info');

                    // Submit form via AJAX
                    $.ajax({
                        url: form.attr('action'),
                        type: 'POST',
                        data: form.serialize(),
                        success: function (response) {
                            if (response.redirect) {
                                // Show success message
                                showToast(`Successfully enrolled in "${courseTitle}"!`, 'success');

                                // Update UI to show enrolled state
                                setTimeout(function () {
                                    window.location.href = response.redirect;
                                }, 1500);
                            }
                        },
                        error: function (xhr, status, error) {
                            showToast('Error enrolling in course. Please try again.', 'error');
                            btn.removeClass('loading');
                            btn.prop('disabled', false);
                            btn.html('<i class="fas fa-plus-circle me-2"></i>Enroll Now');
                        }
                    });
                });

                // Handle direct form submission fallback
                $('.enroll-btn').on('click', function (e) {
                    const btn = $(this);
                    if (!btn.hasClass('loading')) {
                        const courseTitle = btn.data('course-title');
                        btn.addClass('loading');
                        showToast(`Enrolling in "${courseTitle}"...`, 'info', 3000);
                    }
                });

                // Show toast notifications from TempData
            @if (TempData["SuccessMessage"] != null)
            {
                <text>showToast('@TempData["SuccessMessage"]', 'success'); </text>
            }
            @if (TempData["ErrorMessage"] != null)
            {
                <text>showToast('@TempData["ErrorMessage"]', 'error'); </text>
            }
            @if (TempData["InfoMessage"] != null)
            {
                <text>showToast('@TempData["InfoMessage"]', 'info'); </text>
            }

                    function showToast(message, type = 'info', duration = 5000) {
                        // Create toast container if it doesn't exist
                        if ($('.toast-container').length === 0) {
                            $('body').append('<div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 1060;"></div>');
                        }

                        const icon = {
                            'success': 'check-circle',
                            'error': 'exclamation-circle',
                            'warning': 'exclamation-triangle',
                            'info': 'info-circle'
                        }[type] || 'info-circle';

                        const toast = $(`
                                <div class="toast align-items-center text-white bg-${type} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                                    <div class="d-flex">
                                        <div class="toast-body">
                                            <i class="fas fa-${icon} me-2"></i>
                                            ${message}
                                        </div>
                                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                                    </div>
                                </div>
                            `);

                        $('.toast-container').append(toast);
                        const bsToast = new bootstrap.Toast(toast[0], {
                            autohide: true,
                            delay: duration
                        });
                        bsToast.show();

                        // Remove after hide
                        toast.on('hidden.bs.toast', function () {
                            $(this).remove();
                        });
                    }

                function getToastIcon(type) {
                    switch (type) {
                        case 'success': return 'check-circle';
                        case 'error': return 'exclamation-circle';
                        case 'warning': return 'exclamation-triangle';
                        case 'info': return 'info-circle';
                        default: return 'info-circle';
                    }
                }
            });
        </script>
    }