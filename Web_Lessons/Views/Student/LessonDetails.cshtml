@model Web_Lessons.ViewModels.StudentLessonViewModel
@{
    Layout = "_StudentLayout";
    ViewData["Title"] = Model?.Lesson?.Title ?? "Lesson Details";
    ViewData["Description"] = Model?.Lesson?.Description;

    // التحقق من Null
    var lesson = Model?.Lesson;
    var course = lesson?.Course ?? new Web_Lessons.Models.Course();
    var isCompleted = Model?.IsCompleted ?? false;
    var currentUserId = User.Identity?.Name;
    var teacherId = course?.Subject?.TeacherId;
}

@section Styles {
    <style>
        .lesson-video-container {
            position: relative;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
        }

        .lesson-progress-bar {
            height: 5px;
            background: #e9ecef;
            position: relative;
            margin-top: 10px;
        }

            .lesson-progress-bar .progress {
                position: absolute;
                height: 100%;
                background: #3498db;
                transition: width 0.3s;
            }

        .completion-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(46, 204, 113, 0.9);
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            z-index: 10;
        }

        .comment-reply {
            margin-left: 50px;
            border-left: 3px solid #dee2e6;
            padding-left: 15px;
        }

        .reaction-btn {
            background: transparent;
            border: none;
            padding: 5px 10px;
            border-radius: 20px;
            transition: all 0.3s;
            cursor: pointer;
        }

            .reaction-btn:hover {
                background: #f8f9fa;
                transform: scale(1.1);
            }

            .reaction-btn.active {
                background: #e3f2fd;
                color: #3498db;
                border: 1px solid #3498db;
            }

        .attachment-card {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            transition: all 0.3s;
        }

            .attachment-card:hover {
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                transform: translateY(-2px);
            }

        .note-section {
            background: #fff9e6;
            border-left: 4px solid #f39c12;
            padding: 15px;
            border-radius: 0 8px 8px 0;
        }

        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
        }

        .emoji-btn {
            font-size: 1.5rem;
            padding: 10px;
            border-radius: 8px;
        }

        .comment-item {
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
            margin-bottom: 15px;
        }

        .comment-replies {
            margin-left: 50px;
            margin-top: 10px;
        }

        .comment-reply {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .toast-container {
            z-index: 9999;
        }

        .typing-indicator {
            font-style: italic;
            color: #6c757d;
            font-size: 0.9rem;
        }

        .badge {
            font-size: 0.8rem;
        }

        /* تحسين الفيديو */
        video {
            width: 100%;
            height: auto;
            display: block;
            background: #000;
        }

        .video-wrapper {
            position: relative;
            width: 100%;
        }
    </style>
}

<div class="row">
    <!-- Lesson Content -->
    <div class="col-md-8">
        <!-- Breadcrumb -->
        <nav aria-label="breadcrumb" class="mb-4">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a asp-controller="Student" asp-action="MyCourses">My Courses</a></li>
                <li class="breadcrumb-item"><a asp-controller="Student" asp-action="CourseDetails" asp-route-id="@course.Id">@course.Title</a></li>
                <li class="breadcrumb-item active">@lesson.Title</li>
            </ol>
        </nav>

        <!-- Lesson Header -->
        <div class="content-card mb-4">
            <div class="d-flex justify-content-between align-items-start mb-3">
                <div>
                    <h3 class="mb-2">@lesson.Title</h3>
                    <div class="d-flex align-items-center text-muted">
                        <span class="me-3">
                            <i class="fas fa-clock me-1"></i>
                            @lesson.DurationMinutes min
                        </span>
                        <span>
                            <i class="fas fa-sort-numeric-up me-1"></i>
                            Lesson @lesson.Order
                        </span>
                        @if (isCompleted)
                        {
                            <span class="ms-3 text-success">
                                <i class="fas fa-check-circle me-1"></i>
                                Completed
                            </span>
                        }
                    </div>
                </div>
                <div>
                    <!-- Mark as Complete Button -->
                    <form id="markCompleteForm">
                        @Html.AntiForgeryToken()
                        <button type="button"
                                class="btn @(isCompleted ? "btn-success" : "btn-primary") mark-complete-btn"
                                data-lesson-id="@lesson.Id"
                        @(isCompleted ? "disabled" : "")>
                            @if (isCompleted)
                            {
                                <i class="fas fa-check me-2"></i>
                                <span>Completed</span>
                            }
                            else
                            {
                                <i class="fas fa-check-circle me-2"></i>
                                <span>Mark as Complete</span>
                            }
                        </button>
                    </form>
                </div>
            </div>

            <!-- Video Player -->
            @if (!string.IsNullOrEmpty(lesson.VideoUrl))
            {
                <div class="lesson-video-container mb-4">
                    @if (isCompleted)
                    {
                        <div class="completion-badge">
                            <i class="fas fa-check me-1"></i> Completed
                        </div>
                    }

                    <div class="video-wrapper">
                        <video id="lessonVideo"
                               controls
                               controlsList="nodownload"
                               preload="metadata"
                               playsinline
                               data-lesson-id="@lesson.Id">
                            <source src="@lesson.VideoUrl" type="video/mp4">
                            <source src="@lesson.VideoUrl" type="video/webm">
                            Your browser does not support HTML5 video.
                        </video>
                    </div>

                    <!-- Progress Bar -->
                    <div class="lesson-progress-bar">
                        <div class="progress" id="videoProgress" style="width: 0%"></div>
                    </div>
                </div>
            }
            else
            {
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    No video available for this lesson.
                </div>
            }

            <!-- Lesson Description -->
            @if (!string.IsNullOrEmpty(lesson.Description))
            {
                <div class="mb-4">
                    <h5>Description</h5>
                    <div class="content-card">
                        @Html.Raw(lesson.Description.Replace("\n", "<br>"))
                    </div>
                </div>
            }

            <!-- Materials Section -->
            @if (!string.IsNullOrEmpty(lesson.PdfUrl))
            {
                <div class="mb-4">
                    <h5 class="mb-3">Lesson Materials</h5>
                    <div class="attachment-card">
                        <div class="d-flex align-items-center">
                            <div class="me-3">
                                <i class="fas fa-file-pdf fa-2x text-danger"></i>
                            </div>
                            <div class="flex-grow-1">
                                <h6 class="mb-1">Lesson Notes</h6>
                                <p class="text-muted small mb-2">PDF document with detailed notes</p>
                                <div class="d-flex gap-2">
                                    <a href="@lesson.PdfUrl" target="_blank" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-eye me-1"></i> View
                                    </a>
                                    <a href="@lesson.PdfUrl" download class="btn btn-sm btn-outline-success">
                                        <i class="fas fa-download me-1"></i> Download
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }

            <!-- Take Notes Section -->
            <div class="mb-4">
                <h5 class="mb-3">My Notes</h5>
                <div class="note-section">
                    <textarea id="lessonNotes" class="form-control" rows="4"
                              placeholder="Take notes about this lesson..."></textarea>
                    <div class="text-end mt-2">
                        <button id="saveNotesBtn" class="btn btn-sm btn-warning">
                            <i class="fas fa-save me-1"></i> Save Notes
                        </button>
                        <button id="clearNotesBtn" class="btn btn-sm btn-outline-secondary ms-2">
                            <i class="fas fa-trash me-1"></i> Clear
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Comments Section -->
        <div class="content-card">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h5 class="mb-0">Discussion (<span id="totalComments">@Model?.TotalComments</span>)</h5>
                <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-outline-primary" id="refreshComments">
                        <i class="fas fa-sync-alt me-1"></i> Refresh
                    </button>
                    @if (teacherId != null)
                    {
                        <a href="javascript:void(0)"
                           class="btn btn-sm @(Model?.HasUnreadMessages == true ? "btn-warning" : "btn-outline-info") position-relative ask-teacher-btn"
                           data-teacher-id="@teacherId"
                           data-lesson-id="@lesson.Id">
                            <i class="fas fa-comments me-1"></i> Ask Teacher
                            @if (Model?.UnreadMessagesCount > 0)
                            {
                                <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                                    @Model.UnreadMessagesCount
                                    <span class="visually-hidden">unread messages</span>
                                </span>
                            }
                        </a>
                    }
                </div>
            </div>

            <!-- Typing Indicator -->
            <div id="typingIndicator" class="typing-indicator mb-2" style="display: none;"></div>

            <!-- Add Comment -->
            <div class="mb-4" id="commentFormContainer">
                <form id="addCommentForm">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="lessonId" value="@lesson.Id" />
                    <input type="hidden" name="mentionedUserId" id="mentionedUserId" />
                    <div class="mb-3">
                        <textarea name="content" class="form-control" rows="3"
                                  placeholder="Share your thoughts, ask questions, or help others..."
                                  id="commentText" required></textarea>
                        <div class="form-text">
                            <span id="charCountComment">0</span>/1000 characters
                        </div>
                        <div id="mentionPreview" class="small text-primary mt-1" style="display: none;"></div>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="mentionBtn">
                                <i class="fas fa-at"></i> Mention
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="addEmojiBtn">
                                <i class="fas fa-smile"></i> Emoji
                            </button>
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button"
                                        id="reactionQuickBtn" data-bs-toggle="dropdown">
                                    <i class="fas fa-thumbs-up"></i> Quick React
                                </button>
                                <ul class="dropdown-menu">
                                    <li><button type="button" class="dropdown-item reaction-quick" data-reaction="like">👍 Like</button></li>
                                    <li><button type="button" class="dropdown-item reaction-quick" data-reaction="love">❤️ Love</button></li>
                                    <li><button type="button" class="dropdown-item reaction-quick" data-reaction="haha">😄 Haha</button></li>
                                    <li><button type="button" class="dropdown-item reaction-quick" data-reaction="wow">😲 Wow</button></li>
                                </ul>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary" id="postCommentBtn">
                            <i class="fas fa-paper-plane me-2"></i>Post Comment
                        </button>
                    </div>
                </form>
            </div>

            <!-- Comments List -->
            <div id="commentsList">
                <!-- التعليقات سيتم تحميلها هنا عبر AJAX -->
            </div>

            <!-- Loading Spinner -->
            <div id="commentsLoading" class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading comments...</span>
                </div>
                <p class="text-muted mt-2">Loading discussions...</p>
            </div>

            <!-- No Comments Message -->
            <div id="noCommentsMessage" class="text-center py-4" style="display: none;">
                <i class="fas fa-comments fa-3x text-muted mb-3"></i>
                <p class="text-muted">No comments yet. Be the first to start the discussion!</p>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="col-md-4">
        <!-- Course Info -->
        <div class="content-card mb-4">
            <h5 class="mb-3">Course Information</h5>
            <div class="mb-3">
                <small class="text-muted d-block">Course</small>
                <a asp-controller="Student" asp-action="CourseDetails" asp-route-id="@course.Id"
                   class="text-primary text-decoration-none">
                    <i class="fas fa-book me-1"></i>@course.Title
                </a>
            </div>
            <div class="mb-3">
                <small class="text-muted d-block">Subject</small>
                <span><i class="fas fa-tag me-1"></i>@course.Subject?.Name</span>
            </div>
            <div class="mb-3">
                <small class="text-muted d-block">Level</small>
                <span class="badge bg-info">@course.Level</span>
            </div>
            <div class="mb-3">
                <small class="text-muted d-block">Duration</small>
                <span><i class="fas fa-clock me-1"></i>@lesson.DurationMinutes minutes</span>
            </div>
            <hr>
            <div class="mb-3">
                <small class="text-muted d-block">Your Progress</small>
                <div class="progress" style="height: 10px;">
                    <div class="progress-bar bg-success" id="courseProgressBar" style="width: @(Model?.CourseProgress ?? 0)%"></div>
                </div>
                <small id="progressText">@(Model?.CompletedLessons ?? 0)/@(Model?.TotalLessonsInCourse ?? 0) lessons completed</small>
            </div>
        </div>

        <!-- Course Lessons -->
        <div class="content-card mb-4">
            <h5 class="mb-3">Course Lessons (@Model?.TotalLessonsInCourse)</h5>
            <div id="courseLessonsList" class="list-group list-group-flush">
                <!-- الدروس سيتم تحميلها هنا عبر JavaScript -->
            </div>
        </div>

        <!-- Navigation -->
        <div class="content-card">
            <h5 class="mb-3">Navigation</h5>
            <div class="d-grid gap-2">
                @if (Model?.PreviousLesson != null)
                {
                    <a asp-controller="Student" asp-action="LessonDetails" asp-route-id="@Model.PreviousLesson.Id"
                       class="btn btn-outline-primary">
                        <i class="fas fa-arrow-left me-2"></i> Previous Lesson
                    </a>
                }
                @if (Model?.NextLesson != null)
                {
                    <a asp-controller="Student" asp-action="LessonDetails" asp-route-id="@Model.NextLesson.Id"
                       class="btn btn-primary">
                        Next Lesson <i class="fas fa-arrow-right ms-2"></i>
                    </a>
                }
                else
                {
                    <a asp-controller="Student" asp-action="CourseDetails" asp-route-id="@course.Id"
                       class="btn btn-success">
                        Back to Course <i class="fas fa-book ms-2"></i>
                    </a>
                }
            </div>
        </div>
    </div>
</div>

<!-- Emoji Picker Modal -->
<div class="modal fade" id="emojiPickerModal" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <h6 class="modal-title">Select Emoji</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="emoji-grid">
                    @foreach (var emoji in new[] { "😀", "😂", "😊", "👍", "👏", "🎉", "🔥", "⭐", "💡", "❓" })
                    {
                        <button type="button" class="btn btn-sm btn-outline-secondary emoji-btn" data-emoji="@emoji">
                            @emoji
                        </button>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Ask Teacher Modal -->
<div class="modal fade" id="askTeacherModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ask Teacher</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="askTeacherForm">
                <div class="modal-body">
                    <input type="hidden" name="teacherId" id="modalTeacherId" />
                    <input type="hidden" name="lessonId" id="modalLessonId" />
                    <div class="mb-3">
                        <label class="form-label">Your Question</label>
                        <textarea name="initialMessage" class="form-control" rows="4"
                                  placeholder="What would you like to ask the teacher about this lesson?"
                                  required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="sendMessageBtn">
                        <i class="fas fa-paper-plane me-2"></i>Send Message
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.1/signalr.min.js"></script>
    <script>
        $(document).ready(function () {
            console.log("LessonDetails page loaded for lesson: @lesson?.Id");
            const antiForgeryToken = $('input[name="__RequestVerificationToken"]').val();

            // ========== الدوال المساعدة ==========
            function showToast(message, type = 'info') {
                const icon = {
                    'success': 'check-circle',
                    'danger': 'exclamation-circle',
                    'warning': 'exclamation-triangle',
                    'info': 'info-circle'
                }[type] || 'info-circle';

                const toast = $(`
                                            <div class="toast align-items-center text-white bg-${type} border-0" role="alert">
                                                <div class="d-flex">
                                                    <div class="toast-body">
                                                        <i class="fas fa-${icon} me-2"></i>
                                                        ${message}
                                                    </div>
                                                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                                                </div>
                                            </div>
                                        `);

                if ($('.toast-container').length === 0) {
                    $('body').append('<div class="toast-container position-fixed bottom-0 end-0 p-3"></div>');
                }

                $('.toast-container').append(toast);
                const bsToast = new bootstrap.Toast(toast[0], {
                    autohide: true,
                    delay: 3000
                });
                bsToast.show();

                toast.on('hidden.bs.toast', function () {
                    $(this).remove();
                });
            }

            function getReactionEmoji(type) {
                const emojis = {
                    'like': '👍',
                    'love': '❤️',
                    'haha': '😄',
                    'wow': '😲',
                    'sad': '😢',
                    'angry': '😠'
                };
                return emojis[type] || '👍';
            }

            function formatCommentContent(content) {
                // تحويل الروابط إلى روابط قابلة للنقر
                return content.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" class="text-primary">$1</a>');
            }

            function formatReactions(reactions) {
                if (!reactions) return '';
                return Object.entries(reactions)
                    .map(([type, count]) =>
                        `<span class="badge bg-light text-dark me-1">
                                                    ${getReactionEmoji(type)} ${count}
                                                </span>`
                    )
                    .join('');
            }

            function formatReplies(replies) {
                return replies.map(reply => `
                                            <div class="comment-reply mb-2">
                                                <div class="d-flex">
                                                    <div class="me-2">
                                                        <img src="${reply.userProfileImage || '/images/default-avatar.png'}"
                                                             alt="${reply.userName}"
                                                             class="rounded-circle" style="width: 30px; height: 30px;">
                                                    </div>
                                                    <div class="flex-grow-1">
                                                        <div class="d-flex justify-content-between">
                                                            <strong>${reply.userName}</strong>
                                                            <small class="text-muted">${reply.timeAgo}</small>
                                                        </div>
                                                        <div>${formatCommentContent(reply.content)}</div>
                                                    </div>
                                                </div>
                                            </div>
                                        `).join('');
            }

            // ========== تحميل التعليقات ==========
            function loadComments() {
                $('#commentsLoading').show();
                $('#commentsList').hide();
                $('#noCommentsMessage').hide();

                $.ajax({
                    url: '/Student/GetComments',
                    type: 'GET',
                    data: { lessonId: @lesson?.Id },
                    success: function (response) {
                        console.log("Comments loaded:", response);

                        if (response.success && response.comments && response.comments.length > 0) {
                            displayComments(response.comments);
                            $('#totalComments').text(response.totalComments || response.comments.length);
                            $('#commentsList').show();
                        } else {
                            $('#commentsList').hide();
                            $('#noCommentsMessage').show();
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error("Error loading comments:", error);
                        showToast('Error loading comments', 'danger');
                    },
                    complete: function () {
                        $('#commentsLoading').hide();
                    }
                });
            }

            // عرض التعليقات
            function displayComments(comments) {
                let html = '';

                comments.forEach(comment => {
                    html += `
                                                <div class="comment-item mb-3" data-comment-id="${comment.id}">
                                                    <div class="d-flex">
                                                        <div class="me-3">
                                                            <img src="${comment.userProfileImage || '/images/default-avatar.png'}"
                                                                 alt="${comment.userName}"
                                                                 class="rounded-circle" style="width: 40px; height: 40px;">
                                                        </div>
                                                        <div class="flex-grow-1">
                                                            <div class="d-flex justify-content-between">
                                                                <div>
                                                                    <strong>${comment.userName}</strong>
                                                                    ${comment.isTeacher ? '<span class="badge bg-primary ms-2">Teacher</span>' : ''}
                                                                    <span class="text-muted ms-2">${comment.timeAgo}</span>
                                                                </div>
                                                                <div class="dropdown">
                                                                    <button class="btn btn-sm btn-link text-muted" type="button"
                                                                            data-bs-toggle="dropdown">
                                                                        <i class="fas fa-ellipsis-v"></i>
                                                                    </button>
                                                                    <ul class="dropdown-menu">
                                                                        <li><a class="dropdown-item reply-comment-btn" href="#"
                                                                               data-comment-id="${comment.id}">
                                                                            <i class="fas fa-reply me-2"></i>Reply
                                                                        </a></li>
                                                                        ${comment.canEdit ? `
                                                                        <li><a class="dropdown-item edit-comment-btn" href="#"
                                                                               data-comment-id="${comment.id}">
                                                                            <i class="fas fa-edit me-2"></i>Edit
                                                                        </a></li>` : ''}
                                                                        ${comment.canDelete ? `
                                                                        <li><a class="dropdown-item text-danger delete-comment-btn" href="#"
                                                                               data-comment-id="${comment.id}">
                                                                            <i class="fas fa-trash me-2"></i>Delete
                                                                        </a></li>` : ''}
                                                                    </ul>
                                                                </div>
                                                            </div>
                                                            <div class="mt-2">
                                                                ${formatCommentContent(comment.content)}
                                                                ${comment.isEdited ? '<small class="text-muted ms-2">(edited)</small>' : ''}
                                                            </div>

                                                            <!-- التفاعلات -->
                                                            <div class="mt-2 d-flex align-items-center">
                                                                <div class="d-flex gap-1">
                                                                    <button class="btn btn-sm reaction-btn ${comment.currentUserReaction === 'like' ? 'active' : ''}"
                                                                            onclick="addReaction(${comment.id}, 'like')">
                                                                        👍
                                                                    </button>
                                                                    <button class="btn btn-sm reaction-btn ${comment.currentUserReaction === 'love' ? 'active' : ''}"
                                                                            onclick="addReaction(${comment.id}, 'love')">
                                                                        ❤️
                                                                    </button>
                                                                    <button class="btn btn-sm reaction-btn ${comment.currentUserReaction === 'haha' ? 'active' : ''}"
                                                                            onclick="addReaction(${comment.id}, 'haha')">
                                                                        😄
                                                                    </button>
                                                                    <button class="btn btn-sm reaction-btn"
                                                                            onclick="addReaction(${comment.id}, 'wow')">
                                                                        😲
                                                                    </button>
                                                                </div>
                                                                <div class="ms-3">
                                                                    ${formatReactions(comment.reactions)}
                                                                </div>
                                                                <div class="ms-auto">
                                                                    <button class="btn btn-sm btn-outline-secondary reply-comment-btn"
                                                                            data-comment-id="${comment.id}">
                                                                        <i class="fas fa-reply me-1"></i>Reply
                                                                    </button>
                                                                </div>
                                                            </div>

                                                            <!-- نموذج الرد -->
                                                            <div id="replyForm-${comment.id}" class="mt-3" style="display: none;">
                                                                <form class="add-reply-form" data-comment-id="${comment.id}">
                                                                    <input type="hidden" name="lessonId" value="@lesson.Id" />
                                                                    <input type="hidden" name="parentCommentId" value="${comment.id}" />
                                                                    <div class="input-group">
                                                                        <input type="text" name="content" class="form-control"
                                                                               placeholder="Write a reply..." required>
                                                                        <button type="submit" class="btn btn-primary">
                                                                            <i class="fas fa-paper-plane"></i>
                                                                        </button>
                                                                    </div>
                                                                </form>
                                                            </div>

                                                            <!-- الردود -->
                                                            <div id="replies-${comment.id}" class="comment-replies mt-3">
                                                                ${comment.replies && comment.replies.length > 0 ?
                            formatReplies(comment.replies) : ''}
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            `;
                });

                $('#commentsList').html(html);
            }

            // ========== إضافة تعليق جديد ==========
            $('#addCommentForm').submit(function (e) {
                e.preventDefault();
                e.stopPropagation();

                const form = $(this);
                const btn = $('#postCommentBtn');
                const content = form.find('textarea[name="content"]').val().trim();
                const lessonId = form.find('input[name="lessonId"]').val();
                const mentionedUserId = form.find('#mentionedUserId').val();

                // التحقق من المدخلات
                if (!content) {
                    showToast('Please enter a comment', 'warning');
                    return;
                }

                if (content.length > 1000) {
                    showToast('Comment cannot exceed 1000 characters', 'warning');
                    return;
                }

                // إظهار حالة التحميل
                btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>Posting...');

                // إرسال البيانات
                $.ajax({
                    url: '/Student/AddComment',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        lessonId: parseInt(lessonId),
                        content: content,
                        mentionedUserId: mentionedUserId || null,
                        __RequestVerificationToken: antiForgeryToken
                    }),
                    headers: {
                        'RequestVerificationToken': antiForgeryToken
                    },
                    success: function (response) {
                        console.log("Comment response:", response);

                        if (response.success) {
                            // مسح النموذج
                            form.find('textarea[name="content"]').val('');
                            form.find('#mentionedUserId').val('');
                            $('#charCountComment').text('0');
                            $('#mentionPreview').hide();

                            // إعادة تحميل التعليقات
                            loadComments();

                            showToast('Comment posted successfully!', 'success');

                            // إرسال إشعار للمعلم
                            sendNotification('new_comment', lessonId);
                        } else {
                            showToast(response.message || 'Error posting comment', 'danger');
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error("AJAX error:", error);
                        showToast('Network error. Please try again.', 'danger');
                    },
                    complete: function () {
                        btn.prop('disabled', false).html('<i class="fas fa-paper-plane me-2"></i>Post Comment');
                    }
                });
            });

            // ========== التفاعلات مع التعليقات ==========
            window.addReaction = function (commentId, reactionType) {
                $.ajax({
                    url: `/Student/AddReaction?commentId=${commentId}&reactionType=${reactionType}`,
                    type: 'POST',
                    headers: {
                        'RequestVerificationToken': antiForgeryToken
                    },
                    success: function (response) {
                        if (response.success) {
                            showToast('Reaction added!', 'success');
                            loadComments(); // إعادة تحميل التعليقات لتحديث التفاعلات
                        }
                    },
                    error: function () {
                        showToast('Error adding reaction', 'danger');
                    }
                });
            };

            // ========== زر Ask Teacher ==========
            $('.ask-teacher-btn').click(function (e) {
                e.preventDefault();
                const teacherId = $(this).data('teacher-id');
                const lessonId = $(this).data('lesson-id');

                $('#modalTeacherId').val(teacherId);
                $('#modalLessonId').val(lessonId);

                const modal = new bootstrap.Modal(document.getElementById('askTeacherModal'));
                modal.show();
            });

            // إرسال رسالة للمعلم
            $('#askTeacherForm').submit(function (e) {
                e.preventDefault();

                const form = $(this);
                const btn = $('#sendMessageBtn');
                const teacherId = $('#modalTeacherId').val();
                const lessonId = $('#modalLessonId').val();
                const message = form.find('textarea[name="initialMessage"]').val().trim();

                if (!message) {
                    showToast('Please enter a message', 'warning');
                    return;
                }

                btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>Sending...');

                // إنشاء محادثة جديدة
                $.ajax({
                    url: '/Chat/Create',
                    type: 'POST',
                    data: {
                        teacherId: teacherId,
                        lessonId: lessonId,
                        initialMessage: message,
                        __RequestVerificationToken: antiForgeryToken
                    },
                    success: function (response) {
                        if (response.success || response.redirectUrl) {
                            showToast('Message sent successfully!', 'success');

                            // إغلاق المودال
                            bootstrap.Modal.getInstance(document.getElementById('askTeacherModal')).hide();

                            // التوجيه إلى صفحة المحادثة بعد ثانيتين
                            setTimeout(() => {
                                if (response.redirectUrl) {
                                    window.location.href = response.redirectUrl;
                                } else {
                                    window.location.href = '/Chat';
                                }
                            }, 2000);
                        } else {
                            showToast('Error sending message', 'danger');
                        }
                    },
                    error: function () {
                        showToast('Error sending message', 'danger');
                    },
                    complete: function () {
                        btn.prop('disabled', false).html('<i class="fas fa-paper-plane me-2"></i>Send Message');
                    }
                });
            });

            // ========== تحميل قائمة دروس الدورة ==========
            function loadCourseLessons() {
                $.ajax({
                    url: '/Student/GetCourseLessons',
                    type: 'GET',
                    data: { courseId: @course?.Id },
                    success: function (response) {
                        if (response.success && response.lessons && response.lessons.length > 0) {
                            let html = '';
                            response.lessons.forEach(lesson => {
                                const isCurrent = lesson.id === @lesson?.Id;
                                html += `
                                                            <a href="/Student/LessonDetails/${lesson.id}"
                                                               class="list-group-item list-group-item-action ${isCurrent ? 'active' : ''}">
                                                                <div class="d-flex w-100 justify-content-between align-items-center">
                                                                    <div>
                                                                        ${lesson.isCompleted ?
                                        '<i class="fas fa-check-circle text-success me-2"></i>' :
                                        (isCurrent ?
                                            '<i class="fas fa-play-circle text-primary me-2"></i>' :
                                            '<i class="fas fa-circle text-muted me-2" style="font-size: 0.8rem;"></i>'
                                        )}
                                                                        <span>${lesson.title}</span>
                                                                    </div>
                                                                    <div class="d-flex align-items-center gap-2">
                                                                        ${lesson.isCompleted ?
                                        '<span class="badge bg-success">Completed</span>' : ''}
                                                                        <small class="text-muted">${lesson.duration} min</small>
                                                                    </div>
                                                                </div>
                                                            </a>
                                                        `;
                            });
                            $('#courseLessonsList').html(html);
                        }
                    }
                });
            }

            // ========== تحميل الملاحظات المحفوظة ==========
            function loadSavedNotes() {
                $.ajax({
                    url: '/Student/GetSavedNotes',
                    type: 'GET',
                    data: { lessonId: @lesson?.Id },
                    success: function (response) {
                        if (response.success && response.notes) {
                            $('#lessonNotes').val(response.notes);
                        }
                    }
                });
            }

            // ========== حفظ الملاحظات ==========
            $('#saveNotesBtn').click(function () {
                saveNotes();
            });

            $('#clearNotesBtn').click(function () {
                if (confirm('Are you sure you want to clear your notes?')) {
                    $('#lessonNotes').val('');
                    saveNotes();
                }
            });

            function saveNotes() {
                const notes = $('#lessonNotes').val();
                const lessonId = @lesson?.Id;

                const btn = $('#saveNotesBtn');
                const originalText = btn.html();

                btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-1"></i>Saving...');

                $.ajax({
                    url: '/Student/SaveNotes',
                    type: 'POST',
                    data: {
                        lessonId: lessonId,
                        notes: notes,
                        __RequestVerificationToken: antiForgeryToken
                    },
                    success: function (response) {
                        if (response.success) {
                            showToast('Notes saved successfully!', 'success');

                            // إرسال إشعار للمعلم
                            sendNotification('notes_saved', lessonId);
                        } else {
                            showToast(response.message || 'Failed to save notes', 'danger');
                        }
                    },
                    error: function () {
                        showToast('Failed to save notes', 'danger');
                    },
                    complete: function () {
                        btn.prop('disabled', false).html('<i class="fas fa-save me-1"></i> Save Notes');
                    }
                });
            }

            // ========== إرسال إشعارات ==========
            function sendNotification(type, relatedId, extraData = null) {
                $.ajax({
                    url: '/Student/SendNotification',
                    type: 'POST',
                    data: {
                        type: type,
                        relatedId: relatedId,
                        extraData: extraData,
                        __RequestVerificationToken: antiForgeryToken
                    }
                });
            }

            // ========== تهيئة الفيديو ==========
            function initializeVideo() {
                const video = document.getElementById('lessonVideo');
                if (video) {
                    // إذا كان الفيديو لا يظهر، نقوم بتحميله يدوياً
                    if (video.readyState === 0) {
                        video.load();
                    }

                    // إضافة event listener للتأكد من تشغيل الفيديو
                    video.addEventListener('loadeddata', function () {
                        console.log('Video loaded successfully');
                        // عرض الفيديو بشكل قسري إذا كان مخفياً
                        video.style.display = 'block';
                        video.style.visibility = 'visible';
                    });

                    video.addEventListener('error', function (e) {
                        console.error('Video error:', e);
                        showToast('Error loading video. Please check your connection.', 'danger');
                    });

                    let progressInterval;

                    video.addEventListener('play', function () {
                        progressInterval = setInterval(updateVideoProgress, 1000);
                    });

                    video.addEventListener('pause', function () {
                        clearInterval(progressInterval);
                    });

                    video.addEventListener('ended', function () {
                        clearInterval(progressInterval);
                        // Auto-mark as complete when video ends
                        if (!$('.mark-complete-btn').prop('disabled')) {
                            markAsComplete();
                        }
                    });

                    function updateVideoProgress() {
                        if (video.duration > 0) {
                            const percent = (video.currentTime / video.duration) * 100;
                            $('#videoProgress').css('width', percent + '%');
                        }
                    }

                    // محاولة تشغيل الفيديو تلقائياً إذا كان هذا هو السلوك المطلوب
                    // video.play().catch(e => console.log('Autoplay prevented:', e));
                }
            }

            // ========== تهيئة الصفحة ==========
            function initializePage() {
                // Character counter for comment
                $('#commentText').on('input', function () {
                    const length = $(this).val().length;
                    $('#charCountComment').text(length);
                    if (length > 1000) {
                        $('#charCountComment').addClass('text-danger');
                    } else {
                        $('#charCountComment').removeClass('text-danger');
                    }
                });

                // Refresh comments button
                $('#refreshComments').click(function () {
                    loadComments();
                    showToast('Comments refreshed', 'info');
                });

                // Emoji picker
                $('#addEmojiBtn').click(function () {
                    $('#emojiPickerModal').modal('show');
                });

                $('.emoji-btn').click(function () {
                    const emoji = $(this).data('emoji');
                    const textarea = $('#commentText');
                    const current = textarea.val();
                    textarea.val(current + emoji);
                    $('#emojiPickerModal').modal('hide');
                    textarea.trigger('input');
                });

                // Quick reactions
                $('.reaction-quick').click(function () {
                    const reaction = $(this).data('reaction');
                    const textarea = $('#commentText');
                    const current = textarea.val();
                    textarea.val(current + getReactionEmoji(reaction));
                    textarea.trigger('input');
                });

                // Mark as complete
                $('.mark-complete-btn').on('click', function () {
                    markAsComplete();
                });
            }

            // ========== إكمال الدرس ==========
            function markAsComplete() {
                const lessonId = $('.mark-complete-btn').data('lesson-id');
                const btn = $('.mark-complete-btn');

                if (btn.prop('disabled')) return;

                // Show loading
                btn.html('<i class="fas fa-spinner fa-spin me-2"></i>Saving...');
                btn.prop('disabled', true);

                $.ajax({
                    url: '/Student/MarkComplete',
                    type: 'POST',
                    data: {
                        lessonId: lessonId,
                        __RequestVerificationToken: antiForgeryToken
                    },
                    success: function (response) {
                        if (response.success) {
                            btn.html('<i class="fas fa-check me-2"></i>Completed');
                            btn.removeClass('btn-primary').addClass('btn-success');

                            // Update progress in sidebar
                            if (response.courseProgress) {
                                $('#courseProgressBar').css('width', response.courseProgress + '%');
                                $('#progressText').text(response.completedLessons + '/' + response.totalLessons + ' lessons completed');
                            }

                            showToast('Lesson marked as complete!', 'success');

                            // Send notification to teacher
                            sendNotification('lesson_completed', lessonId);

                            // Update course lessons list
                            loadCourseLessons();
                        } else {
                            showToast(response.message || 'Error updating progress', 'danger');
                            btn.prop('disabled', false);
                            btn.html('<i class="fas fa-check-circle me-2"></i>Mark as Complete');
                        }
                    },
                    error: function () {
                        showToast('Error updating progress', 'danger');
                        btn.prop('disabled', false);
                        btn.html('<i class="fas fa-check-circle me-2"></i>Mark as Complete');
                    }
                });
            }

            // ========== تهيئة SignalR ==========
            function initializeSignalR() {
                const connection = new signalR.HubConnectionBuilder()
                    .withUrl("/chatHub")
                    .configureLogging(signalR.LogLevel.Information)
                    .build();

                connection.start()
                    .then(() => {
                        console.log("SignalR connected");
                        connection.invoke("JoinLesson", @lesson?.Id);
                    })
                    .catch(err => console.error("SignalR connection error:", err));

                // Handle incoming messages
                connection.on("ReceiveMessage", (message) => {
                    if (message.chatId === @lesson?.Id) {
                        showToast(`New message from ${message.senderName}: ${message.content}`, 'info');
                    }
                });

                connection.on("UserTyping", (data) => {
                    if (data.lessonId === @lesson?.Id && data.userId !== '@currentUserId') {
                        $('#typingIndicator').text(`${data.userName} is typing...`).show();
                        setTimeout(() => {
                            $('#typingIndicator').hide();
                        }, 3000);
                    }
                });
            }

            // تهيئة الصفحة
            initializePage();

            // تحميل التعليقات عند فتح الصفحة
            loadComments();

            // تحميل قائمة الدروس
            loadCourseLessons();

            // تحميل الملاحظات المحفوظة
            loadSavedNotes();

            // تهيئة الفيديو
            initializeVideo();

            // تهيئة SignalR إذا كان الفيديو يعمل
            if (document.getElementById('lessonVideo')) {
                initializeSignalR();
            }

            // تحميل التعليقات كل 30 ثانية للتحديثات الجديدة
            setInterval(loadComments, 30000);
        });
    </script>
}