@using Web_Lessons.ViewModels
@{
    var unreadCount = ViewBag.UnreadNotificationsCount as int? ?? 0;
}

<div class="dropdown notification-dropdown me-3">
    <button class="btn btn-outline-light position-relative" type="button"
            id="notificationDropdown" data-bs-toggle="dropdown" aria-expanded="false">
        <i class="fas fa-bell"></i>
        @if (unreadCount > 0)
        {
            <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                @unreadCount
                <span class="visually-hidden">unread notifications</span>
            </span>
        }
    </button>
    <ul class="dropdown-menu dropdown-menu-end p-0" style="min-width: 350px; max-height: 500px; overflow-y: auto;">
        <li>
            <div class="dropdown-header d-flex justify-content-between align-items-center">
                <strong>Notifications</strong>
                @if (unreadCount > 0)
                {
                    <button class="btn btn-sm btn-link text-decoration-none" id="markAllAsRead">
                        Mark all as read
                    </button>
                }
            </div>
        </li>

        <div id="notificationsList">
            <!-- Notifications will be loaded via AJAX -->
            <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        </div>

        <li>
            <div class="dropdown-footer text-center p-2 border-top">
                <a href="/Student/Notifications" class="text-decoration-none" id="viewAllNotifications">
                    View all notifications
                </a>
            </div>
        </li>
    </ul>
</div>

<style>
    .notification-dropdown .dropdown-menu {
        max-height: 500px;
        overflow-y: auto;
    }

    .notification-item {
        padding: 10px 15px;
        border-bottom: 1px solid #f8f9fa;
        transition: background-color 0.3s;
        cursor: pointer;
    }

        .notification-item:hover {
            background-color: #f8f9fa;
        }

        .notification-item.unread {
            background: linear-gradient(90deg, rgba(67, 97, 238, 0.05), transparent);
            border-left: 3px solid #4361ee;
        }

        .notification-item .text-truncate-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
        }
</style>

<script>
    $(document).ready(function () {
        loadNotifications();

        // Load notifications every 30 seconds
        setInterval(loadNotifications, 30000);

        // Mark all as read
        $('#markAllAsRead').click(function (e) {
            e.preventDefault();
            e.stopPropagation();

            $.ajax({
                url: '/Student/MarkAllNotificationsAsRead',
                type: 'POST',
                headers: {
                    'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                },
                success: function (response) {
                    if (response.success) {
                        loadNotifications();
                        showToast('All notifications marked as read', 'success');
                    }
                },
                error: function () {
                    showToast('Error marking notifications as read', 'danger');
                }
            });
        });

        // View all notifications
        $('#viewAllNotifications').click(function (e) {
            e.preventDefault();
            window.location.href = '/Student/Notifications';
        });

        function loadNotifications() {
            console.log('Loading notifications...');

            $.ajax({
                url: '/Student/GetDashboardNotifications',
                type: 'GET',
                success: function (response) {
                    console.log('Notifications response:', response);

                    if (response.success) {
                        if (response.notifications && response.notifications.length > 0) {
                            renderNotifications(response.notifications);
                            updateNotificationBadge(response.unreadCount);

                            // Show welcome notification if first time
                            const hasNotifications = localStorage.getItem('hasNotifications');
                            if (!hasNotifications && response.notifications.length > 0) {
                                showToast('Notifications loaded successfully', 'success');
                                localStorage.setItem('hasNotifications', 'true');
                            }
                        } else {
                            // Show empty state with option to generate test notification
                            $('#notificationsList').html(`
                                    <div class="text-center py-4">
                                        <i class="fas fa-bell-slash fa-2x text-muted mb-2"></i>
                                        <p class="text-muted mb-3">No notifications yet</p>
                                        <button class="btn btn-sm btn-outline-primary" id="generateTestNotification">
                                            <i class="fas fa-bell me-1"></i> Generate Test Notification
                                        </button>
                                    </div>
                                `);

                            $('#generateTestNotification').click(function (e) {
                                e.preventDefault();
                                e.stopPropagation();

                                $.ajax({
                                    url: '/Student/GenerateTestNotification',
                                    type: 'POST',
                                    headers: {
                                        'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                                    },
                                    success: function (res) {
                                        if (res.success) {
                                            loadNotifications();
                                            showToast('Test notification created', 'success');
                                        }
                                    }
                                });
                            });

                            updateNotificationBadge(0);
                        }
                    } else {
                        showToast('Error loading notifications', 'danger');
                        console.error('Notifications error:', response.message);
                    }
                },
                error: function (xhr, status, error) {
                    console.error('Notifications AJAX error:', error);
                    showToast('Error loading notifications', 'danger');
                }
            });
        }

        function renderNotifications(notifications) {
            const container = $('#notificationsList');
            let html = '';

            notifications.forEach(notification => {
                const icon = getNotificationIcon(notification.type);
                const color = getNotificationColor(notification.type);
                const isUnread = !notification.isRead;
                const link = getNotificationLink(notification);

                html += `
                        <li>
                            <a class="dropdown-item notification-item ${isUnread ? 'unread' : ''}"
                               href="${link}"
                               data-notification-id="${notification.id}"
                               onclick="markNotificationAsRead(${notification.id}, this)">
                                <div class="d-flex">
                                    <div class="me-3">
                                        <i class="${icon} fa-lg ${color}"></i>
                                    </div>
                                    <div class="flex-grow-1">
                                        <div class="d-flex justify-content-between">
                                            <h6 class="mb-0">${notification.title}</h6>
                                            <small class="text-muted">${notification.timeAgo}</small>
                                        </div>
                                        <p class="mb-0 small text-truncate-2">${notification.message}</p>
                                        ${isUnread ? '<span class="badge bg-danger mt-1">New</span>' : ''}
                                    </div>
                                </div>
                            </a>
                        </li>
                    `;
            });

            container.html(html);
        }

        function getNotificationIcon(type) {
            const icons = {
                'new_comment': 'fas fa-comment',
                'lesson_completed': 'fas fa-check-circle',
                'reaction': 'fas fa-thumbs-up',
                'new_reply': 'fas fa-reply',
                'mention': 'fas fa-at',
                'enrollment': 'fas fa-user-plus',
                'new_message': 'fas fa-comments',
                'system': 'fas fa-cog',
                'notes_saved': 'fas fa-edit',
                'course_completed': 'fas fa-trophy'
            };
            return icons[type] || 'fas fa-bell';
        }

        function getNotificationColor(type) {
            const colors = {
                'new_comment': 'text-primary',
                'lesson_completed': 'text-success',
                'reaction': 'text-warning',
                'new_reply': 'text-info',
                'mention': 'text-danger',
                'enrollment': 'text-success',
                'new_message': 'text-primary',
                'system': 'text-secondary',
                'notes_saved': 'text-warning',
                'course_completed': 'text-success'
            };
            return colors[type] || 'text-secondary';
        }

        function getNotificationLink(notification) {
            if (notification.relatedId && notification.relatedType) {
                switch (notification.relatedType) {
                    case 'lesson':
                        return '/Student/LessonDetails/' + notification.relatedId;
                    case 'comment':
                        return '/Student/LessonDetails/' + notification.relatedId + '#comments';
                    case 'chat':
                        return '/Chat/Details/' + notification.relatedId;
                    case 'course':
                        return '/Student/CourseDetails/' + notification.relatedId;
                    default:
                        return '#';
                }
            }
            return '#';
        }

        function markNotificationAsRead(notificationId, element) {
            $.ajax({
                url: '/Student/MarkNotificationAsRead',
                type: 'POST',
                data: {
                    id: notificationId,
                    __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                },
                success: function (response) {
                    if (response.success) {
                        $(element).removeClass('unread');
                        updateNotificationBadge(response.unreadCount);
                    }
                }
            });
        }

        function updateNotificationBadge(count) {
            const badge = $('#notificationDropdown .badge');
            if (count > 0) {
                badge.text(count).show();
            } else {
                badge.hide();
            }
        }
    });
</script>