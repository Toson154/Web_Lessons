@model Web_Lessons.ViewModels.CreateLessonViewModel
@{
    ViewData["Title"] = "Edit Lesson";
    Layout = "_TeacherLayout";
    var courses = ViewBag.Courses as List<SelectListItem>;
}

@section Styles {
    <style>
        .video-upload-container {
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            padding: 2rem;
            text-align: center;
            background-color: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s;
        }

            .video-upload-container:hover {
                border-color: #3498db;
                background-color: #e3f2fd;
            }

            .video-upload-container.dragover {
                border-color: #2ecc71;
                background-color: #d1f7c4;
            }

        .video-preview {
            max-width: 100%;
            max-height: 300px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .upload-progress {
            margin-top: 1rem;
        }

        .nav-tabs {
            border-bottom: 2px solid #dee2e6;
        }

            .nav-tabs .nav-link {
                border: none;
                color: #6c757d;
                font-weight: 500;
            }

                .nav-tabs .nav-link.active {
                    color: #3498db;
                    border-bottom: 2px solid #3498db;
                    background-color: transparent;
                }
    </style>
}

<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">Edit Lesson: @Model.Title</h2>
        <a asp-action="Lessons" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-1"></i> Back to Lessons
        </a>
    </div>

    <!-- Main Form -->
    <div class="card">
        <div class="card-body">
            <form asp-action="EditLesson" method="post" enctype="multipart/form-data"
                  id="lessonForm" class="needs-validation" novalidate>
                @Html.AntiForgeryToken()

                <input type="hidden" asp-for="Id" />
                <input type="hidden" asp-for="PdfUrl" id="existingPdfUrl" />
                <input type="hidden" asp-for="VideoUrl" id="videoUrlField" />

                <div class="row">
                    <!-- Left Column -->
                    <div class="col-lg-8">
                        <!-- Course Selection -->
                        <div class="mb-4">
                            <label asp-for="CourseId" class="form-label fw-bold">
                                Select Course <span class="text-danger">*</span>
                            </label>
                            <select asp-for="CourseId" class="form-select" required id="courseSelect">
                                @if (courses != null && courses.Any())
                                {
                                    <option value="">-- Choose a Course --</option>
                                    @foreach (var course in courses)
                                    {
                                        <option value="@course.Value" selected="@(Model.CourseId.ToString() == course.Value)">
                                            @course.Text
                                        </option>
                                    }
                                }
                                else
                                {
                                    <option value="">No courses available</option>
                                }
                            </select>
                            <span asp-validation-for="CourseId" class="text-danger small"></span>
                        </div>

                        <!-- Lesson Title -->
                        <div class="mb-4">
                            <label asp-for="Title" class="form-label fw-bold">
                                Lesson Title <span class="text-danger">*</span>
                            </label>
                            <input asp-for="Title" class="form-control"
                                   placeholder="e.g., Introduction to Algebra"
                                   required maxlength="150" />
                            <span asp-validation-for="Title" class="text-danger small"></span>
                        </div>

                        <!-- Description -->
                        <div class="mb-4">
                            <label asp-for="Description" class="form-label fw-bold">
                                Lesson Description
                            </label>
                            <textarea asp-for="Description" class="form-control"
                                      rows="5"
                                      placeholder="Describe what students will learn in this lesson..."
                                      maxlength="1000" id="descriptionText"></textarea>
                            <span asp-validation-for="Description" class="text-danger small"></span>
                            <div class="form-text">
                                <span id="charCount">@(Model.Description?.Length ?? 0)</span> / 1000 characters
                            </div>
                        </div>

                        <!-- Duration & Order -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label asp-for="DurationMinutes" class="form-label fw-bold">
                                    Duration <span class="text-danger">*</span>
                                </label>
                                <div class="input-group">
                                    <input asp-for="DurationMinutes" type="number"
                                           class="form-control" min="1" max="300" required />
                                    <span class="input-group-text">minutes</span>
                                </div>
                                <span asp-validation-for="DurationMinutes" class="text-danger small"></span>
                            </div>

                            <div class="col-md-6">
                                <label asp-for="Order" class="form-label fw-bold">
                                    Order in Course <span class="text-danger">*</span>
                                </label>
                                <input asp-for="Order" type="number"
                                       class="form-control" min="1" required
                                       id="orderInput" />
                                <span asp-validation-for="Order" class="text-danger small"></span>
                                <div class="form-text">
                                    Position of this lesson in the course sequence
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column -->
                    <div class="col-lg-4">
                        <!-- Video Upload Section -->
                        <div class="mb-4">
                            <label class="form-label fw-bold mb-3">Lesson Video</label>

                            <!-- Current Video Info -->
                            @if (!string.IsNullOrEmpty(Model.VideoUrl))
                            {
                                <div class="alert alert-info mb-3">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <i class="fas fa-video me-2"></i>
                                            <strong>Current Video:</strong>
                                            <div class="small mt-1">
                                                @if (Model.VideoUrl.Length > 50)
                                                {
                                                    @Model.VideoUrl.Substring(0, 50)

                                                    <text>...</text>
                                                }
                                                else
                                                {
                                                    @Model.VideoUrl
                                                }
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }

                            <!-- Tabs for video options -->
                            <ul class="nav nav-tabs mb-3" id="videoTabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="url-tab" data-bs-toggle="tab"
                                            data-bs-target="#url-pane" type="button" role="tab">
                                        <i class="fas fa-link me-1"></i>Update URL
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="upload-tab" data-bs-toggle="tab"
                                            data-bs-target="#upload-pane" type="button" role="tab">
                                        <i class="fas fa-upload me-1"></i>Upload New
                                    </button>
                                </li>
                            </ul>

                            <div class="tab-content" id="videoTabsContent">
                                <!-- URL Tab -->
                                <div class="tab-pane fade show active" id="url-pane" role="tabpanel">
                                    <div class="form-group">
                                        <input type="url" class="form-control"
                                               placeholder="https://youtube.com/watch?v=..."
                                               id="videoUrlInput" value="@Model.VideoUrl">
                                        <div class="form-text mt-2">
                                            Leave empty to keep current video
                                        </div>
                                    </div>
                                </div>

                                <!-- Upload Tab -->
                                <div class="tab-pane fade" id="upload-pane" role="tabpanel">
                                    <div class="video-upload-container" id="dropArea">
                                        <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                                        <h5>Drop new video file here</h5>
                                        <p class="text-muted">or click to browse</p>
                                        <input type="file" class="d-none" id="videoFileInput"
                                               accept="video/*,.mp4,.mov,.avi,.mkv,.webm,.wmv">
                                        <div class="form-text mt-2">
                                            Max 2GB • MP4, MOV, AVI, MKV, WEBM, WMV
                                        </div>
                                    </div>

                                    <!-- Selected File Info -->
                                    <div id="fileInfo" class="mt-3" style="display: none;">
                                        <div class="alert alert-info">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <i class="fas fa-file-video me-2"></i>
                                                    <span id="fileName"></span>
                                                    <small class="d-block text-muted" id="fileSize"></small>
                                                </div>
                                                <button type="button" class="btn btn-sm btn-outline-danger"
                                                        id="removeFile">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Upload Progress -->
                                    <div id="uploadProgress" class="upload-progress" style="display: none;">
                                        <div class="progress mb-2">
                                            <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated"
                                                 role="progressbar" style="width: 0%">
                                                <span id="progressPercent">0%</span>
                                            </div>
                                        </div>
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div id="progressText" class="small text-muted">Preparing upload...</div>
                                            <button type="button" id="cancelUpload"
                                                    class="btn btn-sm btn-outline-danger">
                                                <i class="fas fa-times me-1"></i> Cancel
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- PDF File Upload -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">PDF Notes</label>

                            @if (!string.IsNullOrEmpty(Model.PdfUrl))
                            {
                                <div class="alert alert-info mb-3">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <i class="fas fa-file-pdf me-2"></i>
                                            <strong>Current PDF:</strong>
                                            <a href="@Model.PdfUrl" target="_blank" class="ms-2">View PDF</a>
                                        </div>
                                        <button type="button" class="btn btn-sm btn-outline-warning"
                                                onclick="replacePdf()">
                                            <i class="fas fa-sync-alt me-1"></i> Replace
                                        </button>
                                    </div>
                                </div>
                            }

                            <div class="input-group">
                                <input asp-for="PdfFile" type="file" class="form-control" accept=".pdf" id="pdfFileInput" />
                                <button class="btn btn-outline-secondary" type="button"
                                        onclick="clearPdfFile()">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="form-text small">
                                Leave empty to keep current PDF (Max 50MB)
                            </div>
                        </div>

                        <!-- Quick Tips -->
                        <div class="card bg-light border-0">
                            <div class="card-body">
                                <h6 class="card-title">
                                    <i class="fas fa-lightbulb text-warning me-2"></i>
                                    Update Tips
                                </h6>
                                <ul class="small mb-0">
                                    <li class="mb-2">Update only the fields you want to change</li>
                                    <li class="mb-2">Changing video will replace the current one</li>
                                    <li class="mb-2">Leave fields empty to keep current values</li>
                                    <li>Test changes before saving</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="mt-5 pt-4 border-top">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <span class="text-muted me-3">
                                <i class="fas fa-info-circle me-1"></i> Fields marked with * are required
                            </span>
                        </div>
                        <div>
                            <a asp-action="Lessons" class="btn btn-outline-danger me-2">
                                <i class="fas fa-times me-1"></i> Cancel
                            </a>
                            <button type="submit" class="btn btn-primary btn-lg px-4" id="submitBtn">
                                <i class="fas fa-save me-2"></i> Update Lesson
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            console.log("Edit Lesson page loaded");

            // Auto-calculate order when course changes
            $('#courseSelect').change(function () {
                var courseId = $(this).val();
                if (courseId) {
                    $.get('/Teacher/GetNextOrderNumber', { courseId: courseId })
                        .done(function (data) {
                            if (data && data.order) {
                                $('#orderInput').val(data.order);
                            }
                        });
                }
            });

            // Character counter for description
            $('#descriptionText').on('input', function () {
                const length = $(this).val().length;
                $('#charCount').text(length);

                if (length > 950) {
                    $('#charCount').addClass('text-danger fw-bold');
                } else {
                    $('#charCount').removeClass('text-danger fw-bold');
                }
            });

            // Video URL input handling
            $('#videoUrlInput').on('input', function () {
                const url = $(this).val().trim();
                if (url && isValidUrl(url)) {
                    $('#videoUrlField').val(url);
                }
            });

            // Drag and drop functionality (simplified)
            const dropArea = document.getElementById('dropArea');
            const fileInput = document.getElementById('videoFileInput');

            dropArea.addEventListener('click', () => fileInput.click());

            // Form validation
            $('#lessonForm').on('submit', function (e) {
                const submitBtn = $('#submitBtn');
                const originalText = submitBtn.html();
                submitBtn.prop('disabled', true)
                    .html('<i class="fas fa-spinner fa-spin me-2"></i> Updating...');

                setTimeout(() => {
                    if (submitBtn.prop('disabled')) {
                        submitBtn.prop('disabled', false).html(originalText);
                    }
                }, 15000);

                return true;
            });

            // PDF handling
            $('#pdfFileInput').change(function () {
                var file = this.files[0];
                var maxSize = 50 * 1024 * 1024;
                if (file && file.size > maxSize) {
                    alert('PDF file size exceeds 50MB limit');
                    $(this).val('');
                }
            });
        });

        function replacePdf() {
            if (confirm('Are you sure you want to replace the current PDF?')) {
                $('#existingPdfUrl').val('');
                $('#pdfFileInput').val('').show();
            }
        }

        function clearPdfFile() {
            $('#pdfFileInput').val('');
        }

        function isValidUrl(string) {
            try {
                new URL(string);
                return true;
            } catch (_) {
                return false;
            }
        }

        // Toast notification function
        function showToast(message, type = 'info') {
            const icon = {
                'success': 'check-circle',
                'danger': 'exclamation-circle',
                'warning': 'exclamation-triangle',
                'info': 'info-circle'
            }[type] || 'info-circle';

            const toast = $(`
                                <div class="toast align-items-center text-white bg-${type} border-0" role="alert">
                                    <div class="d-flex">
                                        <div class="toast-body">
                                            <i class="fas fa-${icon} me-2"></i>
                                            ${message}
                                        </div>
                                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                                    </div>
                                </div>
                            `);

            if ($('.toast-container').length === 0) {
                $('body').append('<div class="toast-container position-fixed bottom-0 end-0 p-3"></div>');
            }

            $('.toast-container').append(toast);
            const bsToast = new bootstrap.Toast(toast[0], {
                autohide: true,
                delay: 5000
            });
            bsToast.show();

            toast.on('hidden.bs.toast', function () {
                $(this).remove();
            });
        }
    </script>
}